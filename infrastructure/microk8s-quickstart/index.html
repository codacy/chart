



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.2">
    
    
      
        <title>Setting up a microk8s instance - Codacy Chart</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#setting-up-a-microk8s-instance" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Codacy Chart" aria-label="Codacy Chart" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="../../images/codacy-logo.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Codacy Chart
            </span>
            <span class="md-header-nav__topic">
              
                Setting up a microk8s instance
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Codacy Chart" class="md-nav__button md-logo">
      
        <img alt="logo" src="../../images/codacy-logo.svg" width="48" height="48">
      
    </a>
    Codacy Chart
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="How to install Codacy on Kubernetes" class="md-nav__link">
      How to install Codacy on Kubernetes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../requirements/" title="System requirements" class="md-nav__link">
      System requirements
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Setting up the Kubernetes infrastructure
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Setting up the Kubernetes infrastructure
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../eks-quickstart/" title="Setting up an Amazon EKS cluster" class="md-nav__link">
      Setting up an Amazon EKS cluster
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aks-quickstart/" title="Setting up an AKS cluster" class="md-nav__link">
      Setting up an AKS cluster
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Setting up a microk8s instance
      </label>
    
    <a href="./" title="Setting up a microk8s instance" class="md-nav__link md-nav__link--active">
      Setting up a microk8s instance
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-concepts" class="md-nav__link">
    1. Concepts
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#helm-and-tiller" class="md-nav__link">
    Helm and tiller
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-prepare-your-environment" class="md-nav__link">
    2. Prepare your environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-installing-microk8s" class="md-nav__link">
    3. Installing microk8s
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-configuring-microk8s" class="md-nav__link">
    4. Configuring microk8s
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-installing-codacy" class="md-nav__link">
    5. Installing Codacy
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../install/" title="Installing Codacy" class="md-nav__link">
      Installing Codacy
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Post-install configuration
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Post-install configuration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/git-providers/github-cloud/" title="GitHub Cloud" class="md-nav__link">
      GitHub Cloud
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/git-providers/github-enterprise/" title="GitHub Enterprise" class="md-nav__link">
      GitHub Enterprise
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/git-providers/gitlab-enterprise/" title="GitLab Enterprise" class="md-nav__link">
      GitLab Enterprise
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/git-providers/bitbucket-enterprise/" title="Bitbucket Server" class="md-nav__link">
      Bitbucket Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/logging/" title="Logging" class="md-nav__link">
      Logging
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/monitoring/" title="Monitoring" class="md-nav__link">
      Monitoring
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Extra
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Extra
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../extra/upgrade/" title="Upgrading Codacy" class="md-nav__link">
      Upgrading Codacy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../extra/uninstall/" title="Uninstalling Codacy" class="md-nav__link">
      Uninstalling Codacy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../extra/database/" title="Database migration guide" class="md-nav__link">
      Database migration guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../extra/k8s-cheatsheet/" title="Kubernetes cheatsheet" class="md-nav__link">
      Kubernetes cheatsheet
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-concepts" class="md-nav__link">
    1. Concepts
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#helm-and-tiller" class="md-nav__link">
    Helm and tiller
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-prepare-your-environment" class="md-nav__link">
    2. Prepare your environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-installing-microk8s" class="md-nav__link">
    3. Installing microk8s
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-configuring-microk8s" class="md-nav__link">
    4. Configuring microk8s
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-installing-codacy" class="md-nav__link">
    5. Installing Codacy
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="setting-up-a-microk8s-instance">Setting up a microk8s instance<a class="headerlink" href="#setting-up-a-microk8s-instance" title="Permanent link">&para;</a></h1>
<p><a href="https://microk8s.io/">Microk8s</a> is a single-package fully conformant lightweight Kubernetes that works on 42 Linux versions. The project is publicly available and can be <a href="https://github.com/ubuntu/microk8s">found here</a>.</p>
<p>Follow the steps below to set up a microk8s instance from scratch, including all the necessary dependencies and configuration.</p>
<h2 id="1-concepts">1. Concepts<a class="headerlink" href="#1-concepts" title="Permanent link">&para;</a></h2>
<h3 id="helm-and-tiller">Helm and tiller<a class="headerlink" href="#helm-and-tiller" title="Permanent link">&para;</a></h3>
<p>Two executables will get installed onto the cluster as part of this process: <code class="codehilite"><span class="err">helm</span></code> and <code class="codehilite"><span class="err">tiller</span></code>.</p>
<ul>
<li><code class="codehilite"><span class="err">helm</span></code> is responsible for resolving the configuration of the chart to be installed, while issuing the correct install commands onto the cluster.</li>
<li><code class="codehilite"><span class="err">tiller</span></code> is responsible for receiving the install commands issued by <code class="codehilite"><span class="err">helm</span></code>, as well as managing the lifecycle of the components that have been installed.</li>
</ul>
<p><code class="codehilite"><span class="err">helm</span></code> is the client facing side, while <code class="codehilite"><span class="err">tiller</span></code> is the server/cluster facing side.</p>
<h2 id="2-prepare-your-environment">2. Prepare your environment<a class="headerlink" href="#2-prepare-your-environment" title="Permanent link">&para;</a></h2>
<p>Prepare your environment to set up the microk8s cluster. For your infrastructure, you will need the following:</p>
<ul>
<li>A machine running Ubuntu 18.04 LTS. You must start a local or remote command line session on this machine.</li>
<li>A <a href="../../requirements/#postgresql-server-setup">PostgreSQL instance with all the necessary databases created</a>. The machine above must be able to connect to this PostgreSQL instance.</li>
</ul>
<p>All the following steps assume that you are starting from a blank slate.</p>
<h2 id="3-installing-microk8s">3. Installing microk8s<a class="headerlink" href="#3-installing-microk8s" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Make sure the machine has the <code class="codehilite"><span class="err">nfs-common</span></code> package installed.</p>
<div class="codehilite"><pre><span></span><code>sudo apt update <span class="o">&amp;&amp;</span> sudo apt install nfs-common -y
</code></pre></div>

</li>
<li>
<p>Install microk8s from the <code class="codehilite"><span class="err">1.15/stable</span></code> channel.</p>
<div class="codehilite"><pre><span></span><code>sudo snap install microk8s --classic --channel<span class="o">=</span><span class="m">1</span>.15/stable <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo usermod -a -G microk8s <span class="nv">$USER</span>  <span class="o">&amp;&amp;</span> <span class="se">\</span>
sudo su - <span class="nv">$USER</span>
</code></pre></div>

<p>Check that microk8s is running.</p>
<div class="codehilite"><pre><span></span><code>microk8s.status --wait-ready
</code></pre></div>

</li>
<li>
<p>Install the version <code class="codehilite"><span class="err">v2.16.3</span></code> of the helm binary</p>
<div class="codehilite"><pre><span></span><code><span class="nv">HELM_PKG</span><span class="o">=</span>helm-v2.16.3-linux-amd64.tar.gz
wget https://get.helm.sh/<span class="nv">$HELM_PKG</span>
tar xvzf <span class="nv">$HELM_PKG</span>
sudo mv linux-amd64/tiller linux-amd64/helm /usr/local/bin
rm -rvf <span class="nv">$HELM_PKG</span> linux-amd64/
</code></pre></div>

</li>
</ol>
<h2 id="4-configuring-microk8s">4. Configuring microk8s<a class="headerlink" href="#4-configuring-microk8s" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>First, we must enable the following plugins on microk8s:</p>
<div class="codehilite"><pre><span></span><code>sudo <span class="nb">echo</span> <span class="s2">&quot;--allow-privileged=true&quot;</span> &gt;&gt; /var/snap/microk8s/current/args/kube-apiserver <span class="o">&amp;&amp;</span> <span class="se">\</span>
microk8s.enable dns <span class="o">&amp;&amp;</span> <span class="se">\</span>
microk8s.status --wait-ready <span class="o">&amp;&amp;</span> <span class="se">\</span>
microk8s.enable storage <span class="o">&amp;&amp;</span> <span class="se">\</span>
microk8s.status --wait-ready <span class="o">&amp;&amp;</span> <span class="se">\</span>
microk8s.enable ingress <span class="o">&amp;&amp;</span> <span class="se">\</span>
microk8s.status --wait-ready <span class="o">&amp;&amp;</span> <span class="se">\</span>
microk8s.stop <span class="o">&amp;&amp;</span> <span class="se">\</span>
microk8s.start <span class="o">&amp;&amp;</span> <span class="se">\</span>
microk8s.status --wait-ready
</code></pre></div>

</li>
<li>
<p>Install Tiller:</p>
<div class="codehilite"><pre><span></span><code>microk8s.kubectl create serviceaccount --namespace kube-system tiller <span class="o">&amp;&amp;</span> <span class="se">\</span>
microk8s.kubectl create clusterrolebinding tiller-cluster-rule --clusterrole<span class="o">=</span>cluster-admin --serviceaccount<span class="o">=</span>kube-system:tiller <span class="o">&amp;&amp;</span> <span class="se">\</span>
helm init --service-account tiller
</code></pre></div>

</li>
<li>
<p>The plugins are now enabled and the cluster bootstrapped. However, we must still wait for some microk8s internals (dns, http, and ingress) plugins to be ready, as failing to do so can result in pods entering a <code class="codehilite"><span class="err">CrashLoopBackoff</span></code> state:</p>
<div class="codehilite"><pre><span></span><code>microk8s.kubectl <span class="nb">wait</span> -n kube-system --for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready pod -l k8s-app<span class="o">=</span>kube-dns
microk8s.kubectl <span class="nb">wait</span> -n kube-system --for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready pod -l k8s-app<span class="o">=</span>hostpath-provisioner
<span class="c1"># If the following command fails, you probably installed the wrong microk8s version</span>
microk8s.kubectl <span class="nb">wait</span> -n default --for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready pod -l <span class="nv">name</span><span class="o">=</span>nginx-ingress-microk8s
microk8s.kubectl -n kube-system <span class="nb">wait</span> --for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Ready pod -l <span class="nv">name</span><span class="o">=</span>tiller
</code></pre></div>

</li>
</ol>
<p>After these commands return successfully, we have ensured that dns, http, and nginx ingress are enabled and working properly inside the cluster.</p>
<h2 id="5-installing-codacy">5. Installing Codacy<a class="headerlink" href="#5-installing-codacy" title="Permanent link">&para;</a></h2>
<p>Any <code class="codehilite"><span class="err">kubectl</span></code> command from <a href="../../install/">our chart installation</a> must be executed as a <code class="codehilite"><span class="err">microk8s.kubectl</span></code> command. You can also create an alias to simplify the process:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">alias</span> <span class="nv">kubectl</span><span class="o">=</span><span class="s1">&#39;microk8s.kubectl&#39;</span>
</code></pre></div>

<p>When you get to the installation step you also need to append the <a href="https://github.com/codacy/chart/blob/master/codacy/values-microk8s.yaml"><code class="codehilite"><span class="err">values-microk8s.yaml</span></code></a> configuration that downsizes some of the limits, making it easier to fit in the lightweight solution that is microk8s.</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../aks-quickstart/" title="Setting up an AKS cluster" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Setting up an AKS cluster
              </span>
            </div>
          </a>
        
        
          <a href="../../install/" title="Installing Codacy" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Installing Codacy
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            © <a href="https://www.codacy.com/">Codacy</a>
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="../../javascripts/extra.js"></script>
      
    
  </body>
</html>