



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>Database Migration Guide - Codacy Chart</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.1b62728e.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#database-migration-guide" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Codacy Chart" class="md-header-nav__button md-logo">
          
            <img src="../../images/codacy-logo.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Codacy Chart
            </span>
            <span class="md-header-nav__topic">
              
                Database Migration Guide
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Codacy Chart" class="md-nav__button md-logo">
      
        <img src="../../images/codacy-logo.svg" width="48" height="48">
      
    </a>
    Codacy Chart
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Codacy Chart" class="md-nav__link">
      Codacy Chart
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Configuration
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Configuration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/" title="Configuration" class="md-nav__link">
      Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/external-dbs/" title="Use external databases" class="md-nav__link">
      Use external databases
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/logging/" title="Logging" class="md-nav__link">
      Logging
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/monitoring/" title="Monitoring" class="md-nav__link">
      Monitoring
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-5" type="checkbox" id="nav-2-5">
    
    <label class="md-nav__link" for="nav-2-5">
      Providers
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-5">
        Providers
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/providers/" title="Providers" class="md-nav__link">
      Providers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/providers/bitbucket-enterprise/" title="Bitbucket Stash" class="md-nav__link">
      Bitbucket Stash
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/providers/github-cloud/" title="GitHub Cloud" class="md-nav__link">
      GitHub Cloud
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/providers/github-enterprise/" title="GitHub Enterprise" class="md-nav__link">
      GitHub Enterprise
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/providers/gitlab-enterprise/" title="GitLab Enterprise" class="md-nav__link">
      GitLab Enterprise
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Installation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Installation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../installation/" title="Install" class="md-nav__link">
      Install
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../installation/uninstall/" title="Uninstall" class="md-nav__link">
      Uninstall
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../installation/upgrade/" title="Upgrade" class="md-nav__link">
      Upgrade
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Migration
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Migration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Database Migration Guide
      </label>
    
    <a href="./" title="Database Migration Guide" class="md-nav__link md-nav__link--active">
      Database Migration Guide
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dumping-your-current-data-out-of-a-running-postgres" class="md-nav__link">
    Dumping your current data out of a running Postgres
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pg_dump" class="md-nav__link">
    pg_dump
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pg_restore" class="md-nav__link">
    pg_restore
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sample-script" class="md-nav__link">
    Sample script
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Quickstart
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Quickstart
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../quickstart/aks_quickstart/" title="AKS cluster quickstart" class="md-nav__link">
      AKS cluster quickstart
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../quickstart/eks_quickstart/" title="EKS cluster setup using terraform" class="md-nav__link">
      EKS cluster setup using terraform
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Requirements
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Requirements
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../requirements/" title="Requirements" class="md-nav__link">
      Requirements
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dumping-your-current-data-out-of-a-running-postgres" class="md-nav__link">
    Dumping your current data out of a running Postgres
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pg_dump" class="md-nav__link">
    pg_dump
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pg_restore" class="md-nav__link">
    pg_restore
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sample-script" class="md-nav__link">
    Sample script
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="database-migration-guide">Database Migration Guide<a class="headerlink" href="#database-migration-guide" title="Permanent link">&para;</a></h1>
<p>Migrating databases between pods is a straightforward process with 3 steps:</p>
<ol>
<li>Dump the databases to a dump file.</li>
<li>Apply the dump file.</li>
<li>Delete the dump file.</li>
</ol>
<p>You will have to dump all the following databases:</p>
<ol>
<li>accounts</li>
<li>analysis</li>
<li>filestore</li>
<li>jobs</li>
<li>metrics</li>
<li>results</li>
<li>results201709</li>
</ol>
<h2 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">&para;</a></h2>
<p>The following operations must be executed by a user which has elevated access (<code class="codehilite"><span class="err">SUPERUSER</span></code>) in the Postgres databases.</p>
<h2 id="dumping-your-current-data-out-of-a-running-postgres">Dumping your current data out of a running Postgres<a class="headerlink" href="#dumping-your-current-data-out-of-a-running-postgres" title="Permanent link">&para;</a></h2>
<p>You will need to know the following:</p>
<ul>
<li><code class="codehilite"><span class="err">$HOSTNAME</span></code> - the hostname where the database is located.</li>
<li><code class="codehilite"><span class="err">$DB_USER</span></code> - the username with privileged access to the database that will perform the dump.</li>
<li><code class="codehilite"><span class="err">$DB</span></code> - the database that you would like to export.</li>
<li><code class="codehilite"><span class="err">$DB_PASSWORD</span></code> - the database password.</li>
</ul>
<h3 id="pg_dump">pg_dump<a class="headerlink" href="#pg_dump" title="Permanent link">&para;</a></h3>
<p>The following command lets you extract a given database into a dump file:</p>
<div class="codehilite"><pre><span></span><span class="nv">PGPASSWORD</span><span class="o">=</span><span class="nv">$DB_PASSWORD</span> pg_dump -h <span class="nv">$HOSTNAME</span> -U <span class="nv">$DB_USER</span> -d <span class="nv">$DB</span> -F t -f /tmp/<span class="nv">$DB</span>.sql.tar<span class="s2">&quot;</span>
</pre></div>

<p>This will dump the file with the <code class="codehilite"><span class="na">.sql.tar</span></code> extension into the <code class="codehilite"><span class="err">/tmp</span></code> folder.</p>
<p><a href="https://www.postgresql.org/docs/10/app-pgdump.html">For more information and additional options, please check the official documentation.</a></p>
<h3 id="pg_restore">pg_restore<a class="headerlink" href="#pg_restore" title="Permanent link">&para;</a></h3>
<p>To restore a database, you can run a <code class="codehilite"><span class="err">pg_restore</span></code> command to consume the dump file and replicate the data onto Postgres:</p>
<div class="codehilite"><pre><span></span><span class="nv">PGPASSWORD</span><span class="o">=</span><span class="nv">$DB_PASSWORD</span> pg_restore -h <span class="nv">$HOSTNAME</span> -U <span class="nv">$DB_USER</span> -d <span class="nv">$DB</span> -F t /tmp/<span class="nv">$DB</span>.sql.tar
</pre></div>

<p><em>NOTE: If you run into any problems while restoring, make sure that you have the database created in that postgres instance (e.g. before restoring the jobs database the postgres instance should have an empty database called <code class="codehilite"><span class="err">jobs</span></code> created there)</em></p>
<p><a href="https://www.postgresql.org/docs/9.6/app-pgrestore.html">For more information and additional options, please check the official documentation.</a></p>
<h2 id="sample-script">Sample script<a class="headerlink" href="#sample-script" title="Permanent link">&para;</a></h2>
<p>Assuming you have the same <code class="codehilite"><span class="err">$DB_USER</span></code> and <code class="codehilite"><span class="err">$DB_PASSWORD</span></code>, and that you want to migrate all the databases from the same hostname to the same destination hostname, you could easily migrate your databases with the following sample script:</p>
<div class="codehilite"><pre><span></span><span class="nv">SRC_HOSTNAME</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">DEST_HOSTNAME</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">DB_USER</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">DB_PASSWORD</span><span class="o">=</span><span class="nv">$4</span>

<span class="nb">declare</span> -a <span class="nv">dbs</span><span class="o">=(</span>accounts analysis filestore <span class="nb">jobs</span> metrics results results201709<span class="o">)</span>
<span class="k">for</span> db in <span class="si">${</span><span class="nv">dbs</span><span class="p">[@]</span><span class="si">}</span>
<span class="k">do</span>
  <span class="nv">PGPASSWORD</span><span class="o">=</span><span class="nv">$DB_PASSWORD</span> pg_dump -h <span class="nv">$SRC_HOSTNAME</span> -U <span class="nv">$DB_USER</span> -d <span class="nv">$DB</span> -F t -f /tmp/<span class="nv">$DB</span>.sql.tar<span class="s2">&quot;</span>
<span class="s2">  PGPASSWORD=</span><span class="nv">$DB_PASSWORD</span><span class="s2"> pg_restore -h </span><span class="nv">$DEST_HOSTNAME</span><span class="s2"> -U </span><span class="nv">$DB_USER</span><span class="s2"> -d </span><span class="nv">$DB</span><span class="s2"> -F t /tmp/</span><span class="nv">$DB</span><span class="s2">.sql.tar</span>
<span class="s2">done</span>
</pre></div>

<p>You could simply invoke it with:</p>
<div class="codehilite"><pre><span></span>migrateDBs.sh postgres–instance1.us-east-1.rds.amazonaws.com postgres–instance1.eu-west-1.rds.amazonaws.com super_user secret_password
</pre></div>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../installation/upgrade/" title="Upgrade" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Upgrade
              </span>
            </div>
          </a>
        
        
          <a href="../../quickstart/aks_quickstart/" title="AKS cluster quickstart" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                AKS cluster quickstart
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Codacy
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="../../javascripts/extra.js"></script>
      
    
  </body>
</html>